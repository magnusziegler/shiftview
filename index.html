<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ShiftView</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=JetBrains+Mono:wght@300;400;500&family=Instrument+Sans:wght@400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0d0d0f;
    --surface: #141418;
    --surface2: #1c1c22;
    --border: rgba(255,255,255,0.07);
    --border2: rgba(255,255,255,0.12);
    --text: #e8e8f0;
    --muted: #666680;
    --accent: #7fffb2;
    --accent2: #ff7f5c;
    --accent3: #7fb8ff;
    --warn: #ffcc44;
    --danger: #ff5c5c;
    --r: 10px;
  }

- { margin: 0; padding: 0; box-sizing: border-box; }

body {
font-family: â€˜Instrument Sansâ€™, sans-serif;
background: var(â€“bg);
color: var(â€“text);
min-height: 100vh;
overflow-x: hidden;
}

/* â”€â”€ UPLOAD SCREEN â”€â”€ */
#upload-screen {
min-height: 100vh;
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
padding: 40px 20px;
position: relative;
}

.bg-grid {
position: fixed;
inset: 0;
background-image:
linear-gradient(rgba(127,255,178,0.03) 1px, transparent 1px),
linear-gradient(90deg, rgba(127,255,178,0.03) 1px, transparent 1px);
background-size: 40px 40px;
pointer-events: none;
}

.bg-glow {
position: fixed;
width: 600px;
height: 600px;
background: radial-gradient(circle, rgba(127,255,178,0.06) 0%, transparent 70%);
top: 50%;
left: 50%;
transform: translate(-50%, -50%);
pointer-events: none;
}

.logo-mark {
font-family: â€˜Syneâ€™, sans-serif;
font-weight: 800;
font-size: 1rem;
letter-spacing: 0.2em;
text-transform: uppercase;
color: var(â€“accent);
margin-bottom: 48px;
opacity: 0.9;
}

.upload-card {
background: var(â€“surface);
border: 1px solid var(â€“border2);
border-radius: 20px;
padding: 48px;
max-width: 520px;
width: 100%;
text-align: center;
position: relative;
z-index: 1;
}

.upload-icon {
width: 72px;
height: 72px;
border-radius: 16px;
background: rgba(127,255,178,0.08);
border: 1px solid rgba(127,255,178,0.2);
display: flex;
align-items: center;
justify-content: center;
margin: 0 auto 28px;
font-size: 2rem;
}

.upload-title {
font-family: â€˜Syneâ€™, sans-serif;
font-size: 1.8rem;
font-weight: 700;
margin-bottom: 10px;
letter-spacing: -0.02em;
}

.upload-sub {
color: var(â€“muted);
font-size: 0.9rem;
line-height: 1.6;
margin-bottom: 36px;
}

.drop-zone {
border: 2px dashed var(â€“border2);
border-radius: var(â€“r);
padding: 40px 24px;
cursor: pointer;
transition: all 0.2s;
margin-bottom: 16px;
}

.drop-zone:hover, .drop-zone.drag-over {
border-color: var(â€“accent);
background: rgba(127,255,178,0.04);
}

.drop-zone input { display: none; }

.drop-label {
font-family: â€˜JetBrains Monoâ€™, monospace;
font-size: 0.78rem;
color: var(â€“muted);
letter-spacing: 0.05em;
}

.drop-label strong { color: var(â€“accent); font-weight: 500; }

.format-tags {
display: flex;
gap: 8px;
justify-content: center;
margin-top: 20px;
}

.format-tag {
background: var(â€“surface2);
border: 1px solid var(â€“border);
border-radius: 6px;
padding: 4px 10px;
font-family: â€˜JetBrains Monoâ€™, monospace;
font-size: 0.68rem;
color: var(â€“muted);
letter-spacing: 0.08em;
}

/* â”€â”€ LOADING OVERLAY â”€â”€ */
#loading-overlay {
position: fixed;
inset: 0;
background: rgba(13,13,15,0.85);
backdrop-filter: blur(6px);
display: none;
flex-direction: column;
align-items: center;
justify-content: center;
z-index: 999;
gap: 20px;
}

#loading-overlay.visible { display: flex; }

.spinner {
width: 48px;
height: 48px;
border: 3px solid rgba(127,255,178,0.15);
border-top-color: var(â€“accent);
border-radius: 50%;
animation: spin 0.8s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }

.loading-text {
font-family: â€˜JetBrains Monoâ€™, monospace;
font-size: 0.78rem;
color: var(â€“muted);
letter-spacing: 0.1em;
}

/* â”€â”€ PERSON SELECT â”€â”€ */
#person-screen {
min-height: 100vh;
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
padding: 40px 20px;
}

.person-card {
background: var(â€“surface);
border: 1px solid var(â€“border2);
border-radius: 20px;
padding: 40px;
max-width: 600px;
width: 100%;
position: relative;
z-index: 1;
}

.person-title {
font-family: â€˜Syneâ€™, sans-serif;
font-size: 1.4rem;
font-weight: 700;
margin-bottom: 6px;
}

.person-sub {
color: var(â€“muted);
font-size: 0.85rem;
margin-bottom: 24px;
}

.search-box {
width: 100%;
background: var(â€“surface2);
border: 1px solid var(â€“border2);
border-radius: var(â€“r);
padding: 12px 16px;
color: var(â€“text);
font-family: â€˜Instrument Sansâ€™, sans-serif;
font-size: 0.9rem;
margin-bottom: 16px;
outline: none;
transition: border-color 0.2s;
}

.search-box:focus { border-color: var(â€“accent); }
.search-box::placeholder { color: var(â€“muted); }

.people-list {
max-height: 380px;
overflow-y: auto;
display: flex;
flex-direction: column;
gap: 4px;
}

.people-list::-webkit-scrollbar { width: 4px; }
.people-list::-webkit-scrollbar-track { background: transparent; }
.people-list::-webkit-scrollbar-thumb { background: var(â€“border2); border-radius: 2px; }

.person-item {
padding: 12px 16px;
border-radius: 8px;
cursor: pointer;
transition: all 0.15s;
display: flex;
align-items: center;
gap: 12px;
border: 1px solid transparent;
}

.person-item:hover {
background: var(â€“surface2);
border-color: var(â€“border);
}

.person-avatar {
width: 36px;
height: 36px;
border-radius: 50%;
background: rgba(127,255,178,0.1);
border: 1px solid rgba(127,255,178,0.2);
display: flex;
align-items: center;
justify-content: center;
font-family: â€˜Syneâ€™, sans-serif;
font-size: 0.75rem;
font-weight: 700;
color: var(â€“accent);
flex-shrink: 0;
}

.person-name { font-size: 0.9rem; font-weight: 500; }
.person-meta { font-size: 0.75rem; color: var(â€“muted); margin-top: 1px; }

/* â”€â”€ MAIN APP â”€â”€ */
#app-screen { display: none; min-height: 100vh; }

.app-header {
background: var(â€“surface);
border-bottom: 1px solid var(â€“border);
padding: 0 24px;
height: 60px;
display: flex;
align-items: center;
justify-content: space-between;
position: sticky;
top: 0;
z-index: 100;
}

.header-left {
display: flex;
align-items: center;
gap: 16px;
}

.header-logo {
font-family: â€˜Syneâ€™, sans-serif;
font-weight: 800;
font-size: 1rem;
letter-spacing: 0.15em;
color: var(â€“accent);
}

.header-divider {
width: 1px;
height: 20px;
background: var(â€“border2);
}

.header-user {
display: flex;
align-items: center;
gap: 10px;
}

.header-avatar {
width: 30px;
height: 30px;
border-radius: 50%;
background: rgba(127,255,178,0.1);
border: 1px solid rgba(127,255,178,0.25);
display: flex;
align-items: center;
justify-content: center;
font-family: â€˜Syneâ€™, sans-serif;
font-size: 0.65rem;
font-weight: 700;
color: var(â€“accent);
}

.header-name { font-size: 0.85rem; font-weight: 500; }

.header-right {
display: flex;
align-items: center;
gap: 8px;
}

.hbtn {
background: var(â€“surface2);
border: 1px solid var(â€“border2);
border-radius: 8px;
padding: 7px 12px;
color: var(â€“text);
font-family: â€˜Instrument Sansâ€™, sans-serif;
font-size: 0.78rem;
font-weight: 500;
cursor: pointer;
transition: all 0.15s;
white-space: nowrap;
}

.hbtn:hover { background: #22222a; }

.hbtn-accent {
background: rgba(127,255,178,0.1);
border-color: rgba(127,255,178,0.3);
color: var(â€“accent);
}

.hbtn-accent:hover { background: rgba(127,255,178,0.18); }

/* Hide button text on small screens */
@media (max-width: 500px) {
.hbtn-label { display: none; }
}

/* View tabs */
.view-tabs {
background: var(â€“surface);
border-bottom: 1px solid var(â€“border);
padding: 0 24px;
display: flex;
gap: 0;
overflow-x: auto;
}

.view-tab {
background: none;
border: none;
border-bottom: 2px solid transparent;
padding: 14px 16px;
color: var(â€“muted);
font-family: â€˜Instrument Sansâ€™, sans-serif;
font-size: 0.82rem;
font-weight: 500;
cursor: pointer;
margin-bottom: -1px;
transition: all 0.15s;
white-space: nowrap;
}

.view-tab.active {
color: var(â€“accent);
border-bottom-color: var(â€“accent);
}

.view-tab:hover:not(.active) { color: var(â€“text); }

/* Content area */
.app-content { padding: 24px; max-width: 1200px; margin: 0 auto; }

/* Week nav */
.week-nav {
display: flex;
align-items: center;
justify-content: space-between;
margin-bottom: 20px;
gap: 12px;
flex-wrap: wrap;
}

.week-title {
font-family: â€˜Syneâ€™, sans-serif;
font-size: 1.4rem;
font-weight: 700;
letter-spacing: -0.02em;
}

.week-subtitle {
font-size: 0.78rem;
color: var(â€“muted);
margin-top: 2px;
font-family: â€˜JetBrains Monoâ€™, monospace;
letter-spacing: 0.05em;
}

.nav-controls {
display: flex;
gap: 8px;
align-items: center;
}

.nav-btn {
width: 36px;
height: 36px;
border-radius: 8px;
background: var(â€“surface2);
border: 1px solid var(â€“border2);
color: var(â€“text);
cursor: pointer;
display: flex;
align-items: center;
justify-content: center;
font-size: 0.9rem;
transition: all 0.15s;
flex-shrink: 0;
}

.nav-btn:hover { border-color: var(â€“accent); color: var(â€“accent); }

.week-jump {
background: var(â€“surface2);
border: 1px solid var(â€“border2);
border-radius: 8px;
padding: 6px 12px;
color: var(â€“text);
font-family: â€˜JetBrains Monoâ€™, monospace;
font-size: 0.72rem;
cursor: pointer;
transition: all 0.15s;
white-space: nowrap;
}

.week-jump:hover { border-color: var(â€“accent); color: var(â€“accent); }

/* â”€â”€ WEEK CALENDAR â”€â”€ */
/* Horizontal scroll wrapper for mobile */
.cal-scroll-wrap {
overflow-x: auto;
-webkit-overflow-scrolling: touch;
margin: 0 -24px;
padding: 0 24px;
}

.cal-grid {
display: grid;
grid-template-columns: repeat(7, minmax(110px, 1fr));
gap: 10px;
min-width: 700px;
}

.cal-day-header {
text-align: center;
padding: 8px 4px 14px;
}

.cal-day-name {
font-family: â€˜JetBrains Monoâ€™, monospace;
font-size: 0.58rem;
letter-spacing: 0.12em;
text-transform: uppercase;
color: var(â€“muted);
margin-bottom: 6px;
}

.cal-day-num {
font-family: â€˜Syneâ€™, sans-serif;
font-size: 1.4rem;
font-weight: 700;
color: var(â€“text);
line-height: 1;
}

.cal-day-col.today .cal-day-num { color: var(â€“accent); }

.cal-day-col.today .cal-day-header::after {
content: â€˜â€™;
display: block;
width: 4px;
height: 4px;
background: var(â€“accent);
border-radius: 50%;
margin: 6px auto 0;
}

.cal-day-col.weekend .cal-day-num { color: var(â€“muted); opacity: 0.6; }

.shift-block {
border-radius: 10px;
padding: 10px 12px;
margin-bottom: 8px;
border: 1px solid transparent;
cursor: pointer;
transition: transform 0.15s, box-shadow 0.15s;
animation: slideIn 0.25s ease both;
}

@keyframes slideIn {
from { opacity: 0; transform: translateY(6px); }
to { opacity: 1; transform: translateY(0); }
}

.shift-block:hover {
transform: translateY(-2px);
box-shadow: 0 8px 24px rgba(0,0,0,0.3);
}

.shift-mine     { background: rgba(127,255,178,0.1);  border-color: rgba(127,255,178,0.25); }
.shift-sick     { background: rgba(255,92,92,0.1);    border-color: rgba(255,92,92,0.3);    }
.shift-vacation { background: rgba(127,184,255,0.1);  border-color: rgba(127,184,255,0.25); }
.shift-off      { background: transparent; border: 1px dashed var(â€“border); }
.shift-project  { background: rgba(255,127,92,0.1);   border-color: rgba(255,127,92,0.25);  }
.shift-other    { background: var(â€“surface2); border-color: var(â€“border); }

.shift-time {
font-family: â€˜JetBrains Monoâ€™, monospace;
font-size: 0.6rem;
letter-spacing: 0.06em;
margin-bottom: 4px;
opacity: 0.7;
}

.shift-mine .shift-time     { color: var(â€“accent);  opacity: 1; }
.shift-sick .shift-time     { color: var(â€“danger);  opacity: 1; }
.shift-vacation .shift-time { color: var(â€“accent3); opacity: 1; }

.shift-label {
font-size: 0.76rem;
font-weight: 600;
line-height: 1.3;
}

.shift-mine .shift-label     { color: var(â€“accent);  }
.shift-sick .shift-label     { color: var(â€“danger);  }
.shift-vacation .shift-label { color: var(â€“accent3); }
.shift-project .shift-label  { color: var(â€“accent2); }
.shift-off .shift-label      { color: var(â€“muted); font-size: 0.7rem; }

.empty-day {
height: 56px;
border-radius: 10px;
border: 1px dashed rgba(255,255,255,0.04);
display: flex;
align-items: center;
justify-content: center;
}

.empty-day span {
font-family: â€˜JetBrains Monoâ€™, monospace;
font-size: 0.6rem;
color: rgba(255,255,255,0.1);
letter-spacing: 0.1em;
}

/* Stats bar */
.stats-bar {
display: grid;
grid-template-columns: repeat(4, 1fr);
gap: 10px;
margin-bottom: 24px;
}

@media (max-width: 640px) {
.stats-bar { grid-template-columns: repeat(2, 1fr); }
}

.stat-card {
background: var(â€“surface);
border: 1px solid var(â€“border);
border-radius: var(â€“r);
padding: 14px 16px;
}

.stat-label {
font-family: â€˜JetBrains Monoâ€™, monospace;
font-size: 0.58rem;
letter-spacing: 0.12em;
text-transform: uppercase;
color: var(â€“muted);
margin-bottom: 6px;
}

.stat-value {
font-family: â€˜Syneâ€™, sans-serif;
font-size: 1.4rem;
font-weight: 700;
}

.stat-value.green  { color: var(â€“accent);  }
.stat-value.orange { color: var(â€“accent2); }
.stat-value.blue   { color: var(â€“accent3); }
.stat-value.red    { color: var(â€“danger);  }

.stat-sub { font-size: 0.7rem; color: var(â€“muted); margin-top: 2px; }

/* Month view */
.month-grid {
display: grid;
grid-template-columns: repeat(7, 1fr);
gap: 4px;
}

@media (max-width: 600px) {
.month-grid { gap: 2px; }
}

.month-day-header {
text-align: center;
padding: 8px 4px;
font-family: â€˜JetBrains Monoâ€™, monospace;
font-size: 0.55rem;
letter-spacing: 0.1em;
text-transform: uppercase;
color: var(â€“muted);
}

.month-cell {
background: var(â€“surface);
border: 1px solid var(â€“border);
border-radius: 8px;
padding: 6px;
min-height: 72px;
cursor: pointer;
transition: border-color 0.15s;
}

.month-cell:hover { border-color: var(â€“border2); }
.month-cell.has-shift { border-color: rgba(127,255,178,0.2); }
.month-cell.today-cell { border-color: var(â€“accent); }
.month-cell.other-month { opacity: 0.3; }

.month-cell-num {
font-family: â€˜Syneâ€™, sans-serif;
font-size: 0.82rem;
font-weight: 700;
color: var(â€“muted);
margin-bottom: 3px;
}

.month-cell.today-cell .month-cell-num { color: var(â€“accent); }
.month-cell.has-shift  .month-cell-num { color: var(â€“text);   }

.month-shift-pill {
font-size: 0.58rem;
padding: 2px 5px;
border-radius: 4px;
margin-top: 2px;
line-height: 1.4;
font-weight: 500;
white-space: nowrap;
overflow: hidden;
text-overflow: ellipsis;
}

.pill-work     { background: rgba(127,255,178,0.15); color: var(â€“accent);  }
.pill-sick     { background: rgba(255,92,92,0.15);   color: var(â€“danger);  }
.pill-vacation { background: rgba(127,184,255,0.15); color: var(â€“accent3); }
.pill-project  { background: rgba(255,127,92,0.15);  color: var(â€“accent2); }
.pill-off      { color: var(â€“muted); font-style: italic; }

/* List view */
.list-view { display: flex; flex-direction: column; gap: 8px; }

.list-item {
background: var(â€“surface);
border: 1px solid var(â€“border);
border-radius: var(â€“r);
padding: 14px 18px;
display: grid;
grid-template-columns: 110px 1fr auto;
align-items: center;
gap: 16px;
transition: border-color 0.15s;
}

@media (max-width: 500px) {
.list-item { grid-template-columns: 90px 1fr; }
.list-time  { display: none; }
}

.list-item:hover { border-color: var(â€“border2); }
.list-item.list-mine     { border-left: 3px solid var(â€“accent);  }
.list-item.list-sick     { border-left: 3px solid var(â€“danger);  }
.list-item.list-vacation { border-left: 3px solid var(â€“accent3); }
.list-item.list-project  { border-left: 3px solid var(â€“accent2); }

.list-date {
font-family: â€˜JetBrains Monoâ€™, monospace;
font-size: 0.72rem;
color: var(â€“muted);
letter-spacing: 0.05em;
}

.list-date strong { color: var(â€“text); display: block; font-size: 0.82rem; margin-bottom: 2px; }

.list-assignment { font-size: 0.86rem; font-weight: 500; }
.list-time { font-family: â€˜JetBrains Monoâ€™, monospace; font-size: 0.7rem; color: var(â€“muted); }

/* ICS Modal */
.modal-overlay {
position: fixed;
inset: 0;
background: rgba(0,0,0,0.7);
backdrop-filter: blur(4px);
align-items: center;
justify-content: center;
z-index: 200;
display: none;
}

.modal-overlay.open { display: flex; }

.modal {
background: var(â€“surface);
border: 1px solid var(â€“border2);
border-radius: 16px;
padding: 32px;
max-width: 440px;
width: 90%;
}

.modal-title {
font-family: â€˜Syneâ€™, sans-serif;
font-size: 1.2rem;
font-weight: 700;
margin-bottom: 8px;
}

.modal-sub {
color: var(â€“muted);
font-size: 0.82rem;
line-height: 1.6;
margin-bottom: 24px;
}

.modal-btns { display: flex; gap: 10px; flex-direction: column; }

.modal-btn {
background: var(â€“surface2);
border: 1px solid var(â€“border2);
border-radius: 10px;
padding: 14px 16px;
color: var(â€“text);
font-family: â€˜Instrument Sansâ€™, sans-serif;
font-size: 0.85rem;
font-weight: 500;
cursor: pointer;
text-align: left;
transition: all 0.15s;
display: flex;
align-items: center;
gap: 12px;
}

.modal-btn:hover { border-color: var(â€“accent); }
.modal-btn-icon { font-size: 1.2rem; }
.modal-btn-desc { font-size: 0.7rem; color: var(â€“muted); margin-top: 1px; }

.modal-close {
background: none;
border: none;
color: var(â€“muted);
font-size: 0.8rem;
cursor: pointer;
margin-top: 16px;
text-align: center;
width: 100%;
font-family: â€˜Instrument Sansâ€™, sans-serif;
transition: color 0.15s;
}

.modal-close:hover { color: var(â€“text); }

/* Legend */
.legend {
display: flex;
gap: 14px;
margin-bottom: 16px;
flex-wrap: wrap;
}

.legend-item {
display: flex;
align-items: center;
gap: 6px;
font-size: 0.7rem;
color: var(â€“muted);
font-family: â€˜JetBrains Monoâ€™, monospace;
}

.legend-dot { width: 8px; height: 8px; border-radius: 2px; }
.dot-work     { background: var(â€“accent);  }
.dot-project  { background: var(â€“accent2); }
.dot-vacation { background: var(â€“accent3); }
.dot-sick     { background: var(â€“danger);  }
.dot-off      { background: var(â€“muted);   }

.hidden { display: none !important; }

::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(â€“border2); border-radius: 3px; }

.week-select {
background: var(â€“surface2);
border: 1px solid var(â€“border2);
border-radius: 8px;
padding: 6px 10px;
color: var(â€“text);
font-family: â€˜JetBrains Monoâ€™, monospace;
font-size: 0.7rem;
cursor: pointer;
outline: none;
max-width: 130px;
}

.week-select option { background: var(â€“surface2); }

.month-nav {
display: flex;
align-items: center;
justify-content: space-between;
margin-bottom: 14px;
}

.month-nav-title {
font-family: â€˜Syneâ€™, sans-serif;
font-size: 1.1rem;
font-weight: 700;
}
</style>

</head>
<body>
<div class="bg-grid"></div>
<div class="bg-glow"></div>

<!-- â”€â”€ LOADING OVERLAY â”€â”€ -->

<div id="loading-overlay">
  <div class="spinner"></div>
  <div class="loading-text" id="loading-text">LÃ¤ser schemaâ€¦</div>
</div>

<!-- â”€â”€ UPLOAD SCREEN â”€â”€ -->

<div id="upload-screen">
  <div class="logo-mark">ShiftView</div>
  <div class="upload-card">
    <div class="upload-icon">ğŸ“‹</div>
    <div class="upload-title">Your schedule, clearly.</div>
    <div class="upload-sub">Drop your production schedule Excel file and get a clean personal calendar view with calendar sync â€” no servers, no accounts, all local.</div>
    <div class="drop-zone" id="drop-zone">
      <input type="file" id="file-input" accept=".xlsx,.xls">
      <div class="drop-label">
        <strong>Click to upload</strong> or drag & drop your schedule here
      </div>
    </div>
    <div class="format-tags">
      <span class="format-tag">.XLSX</span>
      <span class="format-tag">.XLS</span>
      <span class="format-tag">SHAREPOINT EXPORT</span>
    </div>
  </div>
</div>

<!-- â”€â”€ PERSON SELECT SCREEN â”€â”€ -->

<div id="person-screen" class="hidden">
  <div class="bg-grid"></div>
  <div class="logo-mark">ShiftView</div>
  <div class="person-card">
    <div class="person-title">Who are you?</div>
    <div class="person-sub" id="person-count-label">Found people in the schedule. Select your name.</div>
    <input type="text" class="search-box" id="person-search" placeholder="Search nameâ€¦">
    <div class="people-list" id="people-list"></div>
  </div>
</div>

<!-- â”€â”€ MAIN APP â”€â”€ -->

<div id="app-screen">
  <div class="app-header">
    <div class="header-left">
      <div class="header-logo">SHIFTVIEW</div>
      <div class="header-divider"></div>
      <div class="header-user">
        <div class="header-avatar" id="header-avatar"></div>
        <div class="header-name" id="header-name"></div>
      </div>
    </div>
    <div class="header-right">
      <button class="hbtn" onclick="switchPerson()">â‡„ <span class="hbtn-label">Switch</span></button>
      <button class="hbtn hbtn-accent" onclick="openExportModal()">â†“ <span class="hbtn-label">Export</span></button>
    </div>
  </div>

  <div class="view-tabs">
    <button class="view-tab active" data-view="week">Week</button>
    <button class="view-tab" data-view="month">Month</button>
    <button class="view-tab" data-view="list">All shifts</button>
  </div>

  <div class="app-content">
    <div class="stats-bar" id="stats-bar"></div>

```
<!-- Week view -->
<div id="view-week">
  <div class="week-nav">
    <div>
      <div class="week-title" id="week-title"></div>
      <div class="week-subtitle" id="week-subtitle"></div>
    </div>
    <div class="nav-controls">
      <button class="nav-btn" onclick="prevWeek()">â†</button>
      <button class="week-jump" onclick="jumpToday()">Today</button>
      <select class="week-select" id="week-select" onchange="jumpToWeek(this.value)"></select>
      <button class="nav-btn" onclick="nextWeek()">â†’</button>
    </div>
  </div>
  <div class="legend">
    <div class="legend-item"><div class="legend-dot dot-work"></div>Named shift</div>
    <div class="legend-item"><div class="legend-dot dot-project"></div>Project</div>
    <div class="legend-item"><div class="legend-dot dot-vacation"></div>Vacation</div>
    <div class="legend-item"><div class="legend-dot dot-sick"></div>Sick</div>
    <div class="legend-item"><div class="legend-dot dot-off"></div>Off</div>
  </div>
  <div class="cal-scroll-wrap">
    <div class="cal-grid" id="cal-grid"></div>
  </div>
</div>

<!-- Month view -->
<div id="view-month" class="hidden">
  <div class="month-nav">
    <div class="month-nav-title" id="month-title"></div>
    <div class="nav-controls">
      <button class="nav-btn" onclick="prevMonth()">â†</button>
      <button class="week-jump" onclick="jumpTodayMonth()">Today</button>
      <button class="nav-btn" onclick="nextMonth()">â†’</button>
    </div>
  </div>
  <div class="month-grid" id="month-grid"></div>
</div>

<!-- List view -->
<div id="view-list" class="hidden">
  <div class="week-nav">
    <div>
      <div class="week-title">All Shifts</div>
      <div class="week-subtitle" id="list-subtitle"></div>
    </div>
    <div class="nav-controls">
      <select class="week-select" id="list-filter" onchange="renderList()">
        <option value="all">All time</option>
        <option value="upcoming">Upcoming</option>
        <option value="past">Past</option>
      </select>
    </div>
  </div>
  <div class="list-view" id="list-view"></div>
</div>
```

  </div>
</div>

<!-- Export Modal -->

<div class="modal-overlay" id="export-modal">
  <div class="modal">
    <div class="modal-title">Export to Calendar</div>
    <div class="modal-sub">Download as .ics â€” import into Google, Outlook, or Apple Calendar.</div>
    <div class="modal-btns">
      <button class="modal-btn" onclick="exportICS('mine')">
        <div class="modal-btn-icon">ğŸ“…</div>
        <div>
          <div>My shifts only</div>
          <div class="modal-btn-desc">Named shift codes & projects</div>
        </div>
      </button>
      <button class="modal-btn" onclick="exportICS('all')">
        <div class="modal-btn-icon">ğŸ“†</div>
        <div>
          <div>Full year schedule</div>
          <div class="modal-btn-desc">Every working day including leave</div>
        </div>
      </button>
    </div>
    <button class="modal-close" onclick="closeModal()">Cancel</button>
  </div>
</div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STATE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let allPeople = [];
let scheduleData = {};   // { "Name": [ { date, raw, type, label, hours, shiftCode } ] }
let shiftLegend = {};
let selectedPerson = null;
let currentWeekStart = null;
let currentMonth = null;
let currentView = 'week';

const MONTHS_SV = ['Januari','Februari','Mars','April','Maj','Juni','Juli','Augusti','September','Oktober','November','December'];
const DAYS_SV   = ['MÃ¥n','Tis','Ons','Tor','Fre','LÃ¶r','SÃ¶n'];

const KNOWN_SHIFTS = {
  'INTAKE':'08:30â€“17:00','N1':'08:30â€“16:30','N2':'09:30â€“17:30','N3':'11:00â€“19:00',
  'SP HELG':'13:00â€“20:30','SS SÃ„ND':'12:30â€“20:00','MS1':'03:30â€“12:00','MS3':'11:00â€“20:00',
  'RAPPORT':'12:15â€“20:15','AKTUELLT':'11:00â€“22:15','AKTUELLT F':'11:00â€“21:45',
  'UB':'09:00â€“17:00','EB':'09:00â€“17:00','PB':'09:00â€“17:00','AGENDA':'09:00â€“18:00',
  'NYHETSKOLL':'08:00â€“16:00','STORYDESK':'09:00â€“17:00','SPEGELN':'13:00â€“20:30',
};

const STATUS_SICK     = ['SJUK','SICK','ILL'];
const STATUS_VACATION = ['SEM','SEMESTER','VAB','FÃ–RÃ„LDRA','LEDIGT'];
const STATUS_OFF      = ['X','XX','OMF TID UT','KOMP','LEDIG','TJÃ„NSTLEDIG'];

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// FILE HANDLING
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

document.getElementById('drop-zone').addEventListener('click', () =>
  document.getElementById('file-input').click()
);

document.getElementById('file-input').addEventListener('change', e => {
  if (e.target.files[0]) handleFile(e.target.files[0]);
});

const dz = document.getElementById('drop-zone');
dz.addEventListener('dragover',  e => { e.preventDefault(); dz.classList.add('drag-over'); });
dz.addEventListener('dragleave', () => dz.classList.remove('drag-over'));
dz.addEventListener('drop', e => {
  e.preventDefault();
  dz.classList.remove('drag-over');
  if (e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]);
});

function showLoading(msg) {
  document.getElementById('loading-text').textContent = msg || 'LÃ¤ser schemaâ€¦';
  document.getElementById('loading-overlay').classList.add('visible');
}

function hideLoading() {
  document.getElementById('loading-overlay').classList.remove('visible');
}

function handleFile(file) {
  showLoading('LÃ¤ser schemaâ€¦');
  setTimeout(() => { // give browser a frame to show spinner
    const reader = new FileReader();
    reader.onload = e => {
      try {
        const wb = XLSX.read(e.target.result, { type: 'array', cellDates: false });
        parseWorkbook(wb);
      } catch(err) {
        hideLoading();
        alert('Could not read file: ' + err.message);
      }
    };
    reader.readAsArrayBuffer(file);
  }, 50);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// PARSING
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function parseWorkbook(wb) {
  scheduleData = {};
  allPeople    = [];

  const scheduleSheets = wb.SheetNames.filter(n =>
    /jan|feb|mar|apr|maj|jun|jul|aug|sep|okt|nov|dec|2024|2025|2026/i.test(n)
  );

  if (scheduleSheets.length === 0) scheduleSheets.push(wb.SheetNames[0]);

  scheduleSheets.forEach(name => parseSheet(wb.Sheets[name], name));

  allPeople = [...new Set(allPeople)].sort();
  hideLoading();
  showPersonSelect();
}

function parseSheet(ws, sheetName) {
  const range  = XLSX.utils.decode_range(ws['!ref'] || 'A1:A1');
  const maxRow = range.e.r + 1;
  const maxCol = range.e.c + 1;

  const yearMatch = sheetName.match(/20\d\d/);
  const baseYear  = yearMatch ? parseInt(yearMatch[0]) : 2025;

  // â”€â”€ STEP 1: Build a columnâ†’month map by scanning ALL of row 0 â”€â”€
  // This is the key fix: merged cells may only appear at the leftmost column,
  // so we scan every column and remember the last seen month.
  const colMonthMap = buildColMonthMap(ws, maxCol, baseYear);

  // â”€â”€ STEP 2: Find week blocks (every 8 cols, first col = DATUM row) â”€â”€
  const weekBlocks = detectWeekBlocks(ws, maxCol);

  // â”€â”€ STEP 3: Find person rows â”€â”€
  const legendStart = findLegendStart(ws, maxRow);
  const HEADER_WORDS = ['DATUM','VECKA','PÃ…MINNELSER','REMINDER','WEEK','DATE','NYHETSJOBBARE'];

  const personRows = [];
  for (let r = 0; r < Math.min(legendStart, maxRow); r++) {
    const val = String(getCellValue(ws, r, 0) || '').trim();
    if (val && val.length > 2 && !HEADER_WORDS.some(h => val.toUpperCase().startsWith(h))) {
      personRows.push({ row: r, name: cleanPersonName(val) });
    }
  }

  // Build legend from rows below legend start
  for (let r = legendStart; r < maxRow; r++) {
    buildShiftLegendEntry(String(getCellValue(ws, r, 0) || '').trim());
  }

  // â”€â”€ STEP 4: For each person Ã— each week block Ã— each day â”€â”€
  personRows.forEach(({ row, name }) => {
    if (!scheduleData[name]) scheduleData[name] = [];
    if (!allPeople.includes(name)) allPeople.push(name);

    weekBlocks.forEach(blockStart => {
      for (let d = 1; d <= 7; d++) {
        const dayNum = parseInt(getCellValue(ws, 2, blockStart + d));
        if (isNaN(dayNum) || dayNum < 1 || dayNum > 31) continue;

        // â”€â”€ KEY FIX: resolve date using colMonthMap â”€â”€
        const date = resolveDateFromCol(dayNum, blockStart + d, colMonthMap, baseYear);
        if (!date) continue;

        const raw = String(getCellValue(ws, row, blockStart + d) || '').trim();
        if (!raw) continue;

        const parsed = parseAssignment(raw);
        scheduleData[name].push({ date, raw, ...parsed });
      }
    });

    scheduleData[name].sort((a, b) => a.date - b.date);
  });
}

/**
 * Scan row 0 for month names across ALL columns.
 * Returns a map: colIndex â†’ { month (0-indexed), year }
 * We propagate the last seen month rightward.
 */
function buildColMonthMap(ws, maxCol, baseYear) {
  const map = {};
  let currentMonth = 0;
  let currentYear  = baseYear;
  let foundFirst   = false;

  for (let c = 0; c < maxCol; c++) {
    const val = String(getCellValue(ws, 0, c) || '').trim().toUpperCase();
    const mIdx = MONTHS_SV.findIndex(m => val.startsWith(m.toUpperCase()));
    if (mIdx !== -1) {
      // Year rollover: if month goes backwards (Dec â†’ Jan) increment year
      if (foundFirst && mIdx < currentMonth && currentMonth >= 10) currentYear++;
      currentMonth = mIdx;
      foundFirst   = true;
    }
    if (foundFirst) {
      map[c] = { month: currentMonth, year: currentYear };
    }
  }

  // If we never found a month header, fill everything with baseYear/Jan as fallback
  if (!foundFirst) {
    for (let c = 0; c < maxCol; c++) map[c] = { month: 0, year: baseYear };
  }

  return map;
}

/**
 * Create a date from a day number and the column's month info.
 * Normalizes to midnight local time (avoids DST shift bugs).
 */
function resolveDateFromCol(dayNum, col, colMonthMap, baseYear) {
  // Walk left from col to find the nearest month mapping
  let info = null;
  for (let c = col; c >= 0; c--) {
    if (colMonthMap[c]) { info = colMonthMap[c]; break; }
  }
  if (!info) info = { month: 0, year: baseYear };

  try {
    const d = new Date(info.year, info.month, dayNum);
    d.setHours(0, 0, 0, 0);  // normalize â€” critical for DST safety
    if (isNaN(d.getTime())) return null;
    // Sanity check: result must be within Â±2 months of expectation
    if (d.getMonth() !== info.month) return null;
    return d;
  } catch(e) { return null; }
}

function detectWeekBlocks(ws, maxCol) {
  const blocks = [];
  for (let c = 0; c < maxCol; c += 8) {
    const val = String(getCellValue(ws, 2, c) || '').toUpperCase();
    if (val.includes('DATUM') || c === 0) blocks.push(c);
  }
  return blocks.length ? blocks : [0];
}

function findLegendStart(ws, maxRow) {
  for (let r = 50; r < maxRow; r++) {
    const val = String(getCellValue(ws, r, 0) || '').trim();
    if (val.match(/\d+[.:]\d+\s*[-â€“]\s*\d+/) || val.match(/^[A-ZÃ…Ã„Ã–]{1,8}\s+\d+[.:]\d+/)) return r;
  }
  return maxRow;
}

function buildShiftLegendEntry(text) {
  const m = text.match(/^([A-ZÃ…Ã„Ã–0-9\s]+?)\s+(\d+)[.:](\d+)\s*[-â€“]\s*(\d+)[.:](\d+)/i);
  if (!m) return;
  const code = m[1].trim().split(' ')[0].toUpperCase();
  shiftLegend[code] = `${m[2].padStart(2,'0')}:${m[3].padEnd(2,'0')}â€“${m[4].padStart(2,'0')}:${m[5].padEnd(2,'0')}`;
}

function parseAssignment(raw) {
  const upper = raw.toUpperCase().trim();

  if (STATUS_SICK.some(s => upper === s || upper.startsWith(s + ' ')))
    return { type: 'sick',     label: 'SJUK',       hours: '', shiftCode: '' };
  if (STATUS_VACATION.some(s => upper === s || upper.startsWith(s + ' ')))
    return { type: 'vacation', label: raw.trim(),   hours: '', shiftCode: '' };
  if (STATUS_OFF.some(s => upper === s || upper.startsWith(s + ' ')))
    return { type: 'off',      label: raw.trim(),   hours: '', shiftCode: '' };

  const sc = matchShiftCode(upper);
  if (sc) return { type: 'shift', label: sc.code, hours: sc.hours, shiftCode: sc.code };

  const tm = raw.match(/(\d+)[.:](\d+)\s*[-â€“]\s*(\d+)[.:](\d+)/);
  if (tm) {
    return {
      type: 'shift',
      label: raw.replace(/\d+[.:]\d+\s*[-â€“]\s*\d+[.:]\d+/, '').trim() || raw,
      hours: `${tm[1].padStart(2,'0')}:${tm[2].padEnd(2,'0')}â€“${tm[3].padStart(2,'0')}:${tm[4].padEnd(2,'0')}`,
      shiftCode: ''
    };
  }

  return { type: 'project', label: raw.trim(), hours: '', shiftCode: '' };
}

function matchShiftCode(upper) {
  for (const [code, hours] of Object.entries(KNOWN_SHIFTS)) {
    if (upper === code || upper.startsWith(code + ' ') || upper.startsWith(code + '\t'))
      return { code, hours };
  }
  for (const [code, hours] of Object.entries(shiftLegend)) {
    if (upper === code || upper.startsWith(code + ' '))
      return { code, hours };
  }
  return null;
}

function cleanPersonName(raw) {
  return raw.replace(/\(\d+%\)/g, '').replace(/\(.*?\)/g, '').replace(/\s+/g, ' ').trim();
}

function getCellValue(ws, row, col) {
  const cell = ws[XLSX.utils.encode_cell({ r: row, c: col })];
  return cell ? cell.v : null;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// PERSON SELECT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function showPersonSelect() {
  document.getElementById('upload-screen').classList.add('hidden');
  document.getElementById('person-screen').classList.remove('hidden');
  document.getElementById('person-count-label').textContent =
    `Found ${allPeople.length} people. Select your name.`;
  renderPeopleList(allPeople);

  document.getElementById('person-search').oninput = e => {
    const q = e.target.value.toLowerCase();
    renderPeopleList(allPeople.filter(p => p.toLowerCase().includes(q)));
  };
}

function renderPeopleList(people) {
  document.getElementById('people-list').innerHTML = people.map(p => {
    const initials = p.split(' ').filter(Boolean).slice(0,2).map(w => w[0]).join('').toUpperCase();
    const count = scheduleData[p] ? scheduleData[p].length : 0;
    return `<div class="person-item" onclick="selectPerson('${p.replace(/'/g,"\\'")}')">
      <div class="person-avatar">${initials}</div>
      <div>
        <div class="person-name">${p}</div>
        <div class="person-meta">${count} entries</div>
      </div>
    </div>`;
  }).join('');
}

function selectPerson(name) {
  selectedPerson = name;
  const today = new Date();
  currentWeekStart = getWeekStart(today);
  currentMonth = { year: today.getFullYear(), month: today.getMonth() };

  const initials = name.split(' ').filter(Boolean).slice(0,2).map(w => w[0]).join('').toUpperCase();
  document.getElementById('header-avatar').textContent = initials;
  document.getElementById('header-name').textContent   = name;

  document.getElementById('person-screen').classList.add('hidden');
  document.getElementById('app-screen').style.display = 'block';

  buildWeekSelect();
  renderStats();
  setView('week');
}

function switchPerson() {
  document.getElementById('app-screen').style.display = 'none';
  document.getElementById('person-screen').classList.remove('hidden');
  document.getElementById('person-search').value = '';
  renderPeopleList(allPeople);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// DATE HELPERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function getWeekStart(date) {
  const d = new Date(date);
  const day = d.getDay();
  d.setDate(d.getDate() + (day === 0 ? -6 : 1 - day));
  d.setHours(0, 0, 0, 0); // critical: normalize time
  return d;
}

/**
 * Add days to a date safely, normalizing to midnight
 * to prevent DST issues (e.g. spring clock change in Sweden).
 */
function addDays(date, n) {
  const d = new Date(date);
  d.setDate(d.getDate() + n);
  d.setHours(0, 0, 0, 0);
  return d;
}

function formatDate(d) {
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}

function sameDay(a, b) {
  return a.getFullYear() === b.getFullYear() &&
         a.getMonth()    === b.getMonth()    &&
         a.getDate()     === b.getDate();
}

function getWeekNumber(d) {
  const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  date.setUTCDate(date.getUTCDate() + 4 - (date.getUTCDay() || 7));
  const yearStart = new Date(Date.UTC(date.getUTCFullYear(), 0, 1));
  return Math.ceil((((date - yearStart) / 86400000) + 1) / 7);
}

function getShiftsForDate(person, date) {
  if (!scheduleData[person]) return [];
  return scheduleData[person].filter(s => sameDay(s.date, date));
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// VIEW SWITCHING
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

document.querySelectorAll('.view-tab').forEach(tab => {
  tab.addEventListener('click', function() {
    setView(this.dataset.view);
  });
});

function setView(view) {
  currentView = view;

  document.querySelectorAll('.view-tab').forEach(t =>
    t.classList.toggle('active', t.dataset.view === view)
  );

  document.getElementById('view-week') .classList.toggle('hidden', view !== 'week');
  document.getElementById('view-month').classList.toggle('hidden', view !== 'month');
  document.getElementById('view-list') .classList.toggle('hidden', view !== 'list');

  if (view === 'week')  renderWeek();
  if (view === 'month') renderMonth();
  if (view === 'list')  renderList();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// WEEK VIEW
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function renderWeek() {
  const grid  = document.getElementById('cal-grid');
  const today = new Date(); today.setHours(0,0,0,0);

  const days = Array.from({ length: 7 }, (_, i) => addDays(currentWeekStart, i));

  const ws = days[0], we = days[6];
  const monthLabel = ws.getMonth() === we.getMonth()
    ? MONTHS_SV[ws.getMonth()]
    : `${MONTHS_SV[ws.getMonth()]} â€“ ${MONTHS_SV[we.getMonth()]}`;

  document.getElementById('week-title').textContent    = `${ws.getDate()}â€“${we.getDate()} ${monthLabel} ${ws.getFullYear()}`;
  document.getElementById('week-subtitle').textContent = `Vecka ${getWeekNumber(ws)} Â· ${selectedPerson}`;

  // Sync week-select dropdown
  const sel = document.getElementById('week-select');
  const key = formatDate(currentWeekStart);
  for (let i = 0; i < sel.options.length; i++) {
    sel.options[i].selected = sel.options[i].value === key;
  }

  grid.innerHTML = '';
  days.forEach((day, i) => {
    const isToday   = sameDay(day, today);
    const isWeekend = i >= 5;
    const shifts    = getShiftsForDate(selectedPerson, day);

    const col = document.createElement('div');
    col.className = `cal-day-col${isToday ? ' today' : ''}${isWeekend ? ' weekend' : ''}`;

    let html = `<div class="cal-day-header">
      <div class="cal-day-name">${DAYS_SV[i]}</div>
      <div class="cal-day-num">${day.getDate()}</div>
    </div>`;

    if (shifts.length === 0) {
      html += `<div class="empty-day"><span>â€”</span></div>`;
    } else {
      shifts.forEach((s, si) => { html += renderShiftBlock(s, si); });
    }

    col.innerHTML = html;
    grid.appendChild(col);
  });
}

function renderShiftBlock(s, delay) {
  const cls = { shift:'shift-mine', project:'shift-project', vacation:'shift-vacation', sick:'shift-sick', off:'shift-off' }[s.type] || 'shift-other';
  const emo = { vacation:'âœˆ ', sick:'ğŸ¤’ ', off:'â—‹ ' }[s.type] || '';
  const timeStr  = s.hours || (s.type === 'sick' || s.type === 'vacation' ? 'All day' : '');
  const shortLbl = s.label.length > 28 ? s.label.substring(0,26) + 'â€¦' : s.label;
  return `<div class="shift-block ${cls}" style="animation-delay:${delay*0.05}s" title="${escAttr(s.raw)}">
    ${timeStr ? `<div class="shift-time">${timeStr}</div>` : ''}
    <div class="shift-label">${emo}${shortLbl}</div>
  </div>`;
}

function escAttr(s) { return s.replace(/"/g, '&quot;').replace(/</g, '&lt;'); }

function prevWeek()  { currentWeekStart = addDays(currentWeekStart, -7); renderWeek(); }
function nextWeek()  { currentWeekStart = addDays(currentWeekStart,  7); renderWeek(); }
function jumpToday() { currentWeekStart = getWeekStart(new Date()); renderWeek(); }

function jumpToWeek(dateStr) {
  if (!dateStr) return;
  const d = new Date(dateStr);
  d.setHours(0, 0, 0, 0);
  currentWeekStart = d;
  renderWeek();
}

function buildWeekSelect() {
  const shifts = scheduleData[selectedPerson] || [];
  if (!shifts.length) return;
  const first = shifts[0].date;
  const last  = shifts[shifts.length - 1].date;

  const sel = document.getElementById('week-select');
  sel.innerHTML = '';

  let d = getWeekStart(first);
  while (d <= last) {
    const opt = document.createElement('option');
    opt.value = formatDate(d);
    opt.textContent = `V${getWeekNumber(d)} â€” ${MONTHS_SV[d.getMonth()].substring(0,3)} ${d.getDate()}`;
    sel.appendChild(opt);
    d = addDays(d, 7);
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STATS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function renderStats() {
  const shifts = scheduleData[selectedPerson] || [];
  const today  = new Date(); today.setHours(0,0,0,0);

  const upcoming   = shifts.filter(s => s.date >= today);
  const named      = shifts.filter(s => s.type === 'shift');
  const projects   = shifts.filter(s => s.type === 'project');
  const sick       = shifts.filter(s => s.type === 'sick');
  const nextShift  = upcoming.find(s => s.type === 'shift' || s.type === 'project');

  let nextLabel = 'â€”';
  if (nextShift) {
    const diff = Math.round((nextShift.date - today) / 86400000);
    nextLabel = diff === 0 ? 'Today' : diff === 1 ? 'Tomorrow' : `${diff} days`;
  }

  document.getElementById('stats-bar').innerHTML = `
    <div class="stat-card">
      <div class="stat-label">Next shift</div>
      <div class="stat-value green">${nextLabel}</div>
      <div class="stat-sub">${nextShift ? nextShift.label : 'None upcoming'}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Total entries</div>
      <div class="stat-value blue">${shifts.length}</div>
      <div class="stat-sub">${named.length} shifts Â· ${projects.length} projects</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Upcoming</div>
      <div class="stat-value orange">${upcoming.length}</div>
      <div class="stat-sub">from today</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Sick days</div>
      <div class="stat-value ${sick.length > 0 ? 'red' : 'green'}">${sick.length}</div>
      <div class="stat-sub">this year</div>
    </div>`;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// MONTH VIEW
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function renderMonth() {
  const { year, month } = currentMonth;
  document.getElementById('month-title').textContent = `${MONTHS_SV[month]} ${year}`;

  const grid  = document.getElementById('month-grid');
  const today = new Date(); today.setHours(0,0,0,0);
  grid.innerHTML = '';

  DAYS_SV.forEach(d => {
    const h = document.createElement('div');
    h.className = 'month-day-header';
    h.textContent = d;
    grid.appendChild(h);
  });

  let startDow = new Date(year, month, 1).getDay();
  startDow = startDow === 0 ? 6 : startDow - 1;

  const lastDay = new Date(year, month + 1, 0).getDate();

  for (let i = 0; i < startDow; i++) {
    grid.appendChild(makeMonthCell(new Date(year, month, 1 - (startDow - i)), true, today));
  }
  for (let d = 1; d <= lastDay; d++) {
    grid.appendChild(makeMonthCell(new Date(year, month, d), false, today));
  }
  const totalCells = startDow + lastDay;
  const remaining  = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
  for (let i = 1; i <= remaining; i++) {
    grid.appendChild(makeMonthCell(new Date(year, month + 1, i), true, today));
  }
}

function makeMonthCell(date, otherMonth, today) {
  date.setHours(0,0,0,0);
  const shifts   = getShiftsForDate(selectedPerson, date);
  const hasShift = shifts.some(s => s.type !== 'off');
  const isToday  = sameDay(date, today);

  const cell = document.createElement('div');
  cell.className = `month-cell${hasShift ? ' has-shift' : ''}${isToday ? ' today-cell' : ''}${otherMonth ? ' other-month' : ''}`;
  cell.onclick = () => {
    currentWeekStart = getWeekStart(new Date(date));
    setView('week'); // properly activates the tab
  };

  let inner = `<div class="month-cell-num">${date.getDate()}</div>`;
  shifts.slice(0, 2).forEach(s => {
    const cls  = { shift:'pill-work', project:'pill-project', vacation:'pill-vacation', sick:'pill-sick', off:'pill-off' }[s.type] || 'pill-work';
    const lbl  = s.label.length > 12 ? s.label.substring(0,11) + 'â€¦' : s.label;
    inner += `<div class="month-shift-pill ${cls}">${lbl}</div>`;
  });
  if (shifts.length > 2) inner += `<div class="month-shift-pill pill-off">+${shifts.length - 2}</div>`;
  cell.innerHTML = inner;
  return cell;
}

function prevMonth() {
  let { year, month } = currentMonth;
  month--;
  if (month < 0) { month = 11; year--; }
  currentMonth = { year, month };
  renderMonth();
}

function nextMonth() {
  let { year, month } = currentMonth;
  month++;
  if (month > 11) { month = 0; year++; }
  currentMonth = { year, month };
  renderMonth();
}

function jumpTodayMonth() {
  const t = new Date();
  currentMonth = { year: t.getFullYear(), month: t.getMonth() };
  renderMonth();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// LIST VIEW
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function renderList() {
  const filter = document.getElementById('list-filter').value;
  const shifts = scheduleData[selectedPerson] || [];
  const today  = new Date(); today.setHours(0,0,0,0);

  let filtered = shifts;
  if (filter === 'upcoming') filtered = shifts.filter(s => s.date >= today);
  if (filter === 'past')     filtered = shifts.filter(s => s.date <  today);

  document.getElementById('list-subtitle').textContent = `${filtered.length} entries Â· ${selectedPerson}`;

  const listEl = document.getElementById('list-view');
  if (!filtered.length) {
    listEl.innerHTML = '<div style="padding:40px;text-align:center;color:var(--muted);font-family:JetBrains Mono,monospace;font-size:0.8rem">No entries</div>';
    return;
  }

  listEl.innerHTML = filtered.map(s => {
    const cls     = { shift:'list-mine', project:'list-project', vacation:'list-vacation', sick:'list-sick' }[s.type] || '';
    const dow     = ['SÃ¶n','MÃ¥n','Tis','Ons','Tor','Fre','LÃ¶r'][s.date.getDay()];
    const dateStr = `${String(s.date.getDate()).padStart(2,'0')}/${String(s.date.getMonth()+1).padStart(2,'0')}`;
    const emo     = { sick:'ğŸ¤’ ', vacation:'âœˆ ', off:'â—‹ ' }[s.type] || '';
    return `<div class="list-item ${cls}">
      <div class="list-date">
        <strong>${dow} ${dateStr}</strong>
        V${getWeekNumber(s.date)} Â· ${s.date.getFullYear()}
      </div>
      <div class="list-assignment">${emo}${s.label}</div>
      <div class="list-time">${s.hours || ''}</div>
    </div>`;
  }).join('');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ICS EXPORT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function openExportModal() { document.getElementById('export-modal').classList.add('open');    }
function closeModal()       { document.getElementById('export-modal').classList.remove('open'); }

document.getElementById('export-modal').addEventListener('click', function(e) {
  if (e.target === this) closeModal();
});

function exportICS(mode) {
  closeModal();
  const shifts   = scheduleData[selectedPerson] || [];
  const filtered = mode === 'mine'
    ? shifts.filter(s => s.type === 'shift' || s.type === 'project')
    : shifts;

  const lines = [
    'BEGIN:VCALENDAR','VERSION:2.0',
    'PRODID:-//ShiftView//Personal Schedule//EN',
    'CALSCALE:GREGORIAN','METHOD:PUBLISH',
    `X-WR-CALNAME:${selectedPerson} â€“ Schema`,
    'X-WR-TIMEZONE:Europe/Stockholm',
  ];

  filtered.forEach((s, i) => {
    const uid  = `sv-${i}-${formatDate(s.date).replace(/-/g,'')}@shiftview`;
    const sum  = s.label.replace(/,/g,'\\,');
    const desc = s.raw.replace(/,/g,'\\,').replace(/\n/g,'\\n');
    const ymd  = formatDate(s.date).replace(/-/g,'');

    lines.push('BEGIN:VEVENT', `UID:${uid}`);
    if (s.hours && s.hours.includes('â€“')) {
      lines.push(
        `DTSTART;TZID=Europe/Stockholm:${icsDateTime(s.date, s.hours.split('â€“')[0])}`,
        `DTEND;TZID=Europe/Stockholm:${icsDateTime(s.date, s.hours.split('â€“')[1])}`
      );
    } else {
      lines.push(`DTSTART;VALUE=DATE:${ymd}`, `DTEND;VALUE=DATE:${ymd}`);
    }
    lines.push(`SUMMARY:${sum}`, `DESCRIPTION:${desc}`, 'STATUS:CONFIRMED', `DTSTAMP:${icsNow()}`, 'END:VEVENT');
  });

  lines.push('END:VCALENDAR');

  const blob = new Blob([lines.join('\r\n')], { type: 'text/calendar' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `${selectedPerson.replace(/\s+/g,'_')}_schema.ics`;
  a.click();
}

function icsDateTime(date, timeStr) {
  const ymd  = formatDate(date).replace(/-/g,'');
  const m    = (timeStr || '').trim().match(/(\d+):(\d+)/);
  if (!m) return `${ymd}T080000`;
  return `${ymd}T${m[1].padStart(2,'0')}${m[2].padStart(2,'0')}00`;
}

function icsNow() {
  return new Date().toISOString().replace(/[-:]/g,'').replace(/\.\d{3}Z/,'Z');
}
</script>

</body>
</html>